services:
  # ---------------------------------------------------------------------------
  # Database (PostgreSQL)
  # ---------------------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: but_tc_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: skills_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Authentication (OpenLDAP) - Mocking University LDAP
  # ---------------------------------------------------------------------------
  ldap:
    image: osixia/openldap:latest
    container_name: but-tc-ldap
    restart: unless-stopped
    ports:
      - '389:389'
      - '636:636'
    environment:
      - LDAP_ADMIN_PASSWORD=Rangetachambre76*
      - LDAP_DOMAIN=univ-lehavre.fr
      - LDAP_ORGANISATION=Universite du Havre
      - LDAP_BASE_DN=dc=univ-lehavre,dc=fr
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # LDAP Admin (phpLDAPadmin) - Visual Interface for LDAP
  # ---------------------------------------------------------------------------
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: but_tc_ldap_admin
    restart: unless-stopped
    ports:
      - '8081:80'
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldap
      - PHPLDAPADMIN_HTTPS=false
    depends_on:
      - ldap
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # File Storage (Nextcloud) - Mocking IUT Nextcloud
  # ---------------------------------------------------------------------------
  nextcloud:
    image: nextcloud:stable-apache
    container_name: but_tc_nextcloud
    restart: unless-stopped
    ports:
      - "8082:80"
    extra_hosts:
      - "educ-ai.fr:host-gateway"
      - "nextcloud.educ-ai.fr:host-gateway"
      - "only-office.educ-ai.fr:host-gateway"
      - "home.educ-ai.fr:host-gateway"
    environment:
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=Rangetachambre76*
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost 127.0.0.1 nextcloud projet-edu.eu educ-ai.fr *.educ-ai.fr
      - OVERWRITEPROTOCOL=https
      # Using SQLite for the dev instance
      - SQLITE_DATABASE=nextcloud
    volumes:
      - nextcloud_data:/var/www/html
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # OnlyOffice Document Server
  # ---------------------------------------------------------------------------
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: but_tc_onlyoffice
    restart: unless-stopped
    ports:
      - "8083:80"
    extra_hosts:
      - "educ-ai.fr:host-gateway"
      - "nextcloud.educ-ai.fr:host-gateway"
      - "only-office.educ-ai.fr:host-gateway"
      - "home.educ-ai.fr:host-gateway"
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=onlyoffice_secret
      - JWT_HEADER=Authorization
      - USE_UNAUTHORIZED_STORAGE=true
      - ALLOW_PRIVATE_IP_ADDRESS=true
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Mail Server (Mailpit) - Mocking SMTP
  # ---------------------------------------------------------------------------
  mailpit:
    image: axllent/mailpit
    container_name: but_tc_mail
    restart: unless-stopped
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP Port
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Mattermost (PostgreSQL)
  # ---------------------------------------------------------------------------
  db_mattermost:
    image: postgres:15-alpine
    container_name: but_tc_db_mattermost
    restart: unless-stopped
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmpassword
      POSTGRES_DB: mattermost
    volumes:
      - mattermost_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Keycloak (PostgreSQL)
  # ---------------------------------------------------------------------------
  db_keycloak:
    image: postgres:15-alpine
    container_name: but_tc_db_keycloak
    restart: unless-stopped
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak_password
      POSTGRES_DB: keycloak
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Keycloak Identity Provider
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: but_tc_keycloak
    restart: unless-stopped
    command: start-dev --hostname-strict=false
    environment:
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://db_keycloak:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak_password
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=Rangetachambre76*
      - KC_HOSTNAME=keycloak.educ-ai.fr
      - KC_HOSTNAME_STRICT=false
      - KC_PROXY=edge
    depends_on:
      - db_keycloak
    ports:
      - "8080:8080"
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Mattermost Team Edition
  # ---------------------------------------------------------------------------
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: but_tc_mattermost
    restart: unless-stopped
    depends_on:
      - db_mattermost
    environment:
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:mmpassword@db_mattermost:5432/mattermost?sslmode=disable&connect_timeout=10
      - MM_SERVICESETTINGS_SITEURL=https://educ-ai.fr/mattermost
      - MM_SERVICESETTINGS_ALLOWEDUNTRUSTEDINTERNALCONNECTIONS=localhost 127.0.0.1 educ-ai.fr
      - MM_SERVICESETTINGS_ENABLEDEVELOPER=true
    ports:
      - "8065:8065"
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_config:/mattermost/config
      - mattermost_logs:/mattermost/logs
      - mattermost_plugins:/mattermost/plugins
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./apps/api
    container_name: but_tc_api
    restart: unless-stopped
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://app_user:app_password@db:5432/skills_db
      - LDAP_URL=ldap://but-tc-ldap:389
      - LDAP_BASE_DN=dc=univ-lehavre,dc=fr
      - LDAP_BIND_DN=cn=admin,dc=univ-lehavre,dc=fr
      - LDAP_BIND_PASSWORD=Rangetachambre76*
      - NEXTCLOUD_URL=http://projet-edu.eu:8082
      - NEXTCLOUD_ADMIN=admin
      - NEXTCLOUD_PASS=Rangetachambre76*
      - ROOT_PATH=/api
      - KEYCLOAK_URL=http://but_tc_keycloak:8080
      - KEYCLOAK_REALM=but-tc
      - KEYCLOAK_CLIENT_ID=skills-hub-app
      - KEYCLOAK_CLIENT_SECRET=ASzD8MghmcXaTSas1MvjiK9o81DrlEeO
    networks:
      - app_network

  web:
    build:
      context: ./apps/web
    container_name: but_tc_web
    restart: unless-stopped
    depends_on:
      - api
    # Web kept hidden behind Gateway
    networks:
      - app_network

  dashboard:
    build:
      context: ./apps/dashboard
    container_name: but_tc_dashboard
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/local/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
      - api
    networks:
      - app_network

volumes:
  postgres_data:
  ldap_data:
  ldap_config:
  nextcloud_data:
  mattermost_db_data:
  keycloak_db_data:
  mattermost_data:
  mattermost_config:
  mattermost_logs:
  mattermost_plugins:

networks:
  app_network:
    driver: bridge