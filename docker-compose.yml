services:
  # ---------------------------------------------------------------------------
  # Database (PostgreSQL)
  # ---------------------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: but_tc_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: skills_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Authentication (OpenLDAP) - Mocking University LDAP
  # ---------------------------------------------------------------------------
  ldap:
    image: osixia/openldap:latest
    container_name: but_tc_ldap
    restart: unless-stopped
    ports:
      - '389:389'
      - '636:636'
    environment:
      - LDAP_ADMIN_PASSWORD=Rangetachambre76*
      - LDAP_DOMAIN=univ.fr
      - LDAP_ORGANISATION=IUT
      - LDAP_BASE_DN=dc=univ,dc=fr
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # LDAP Admin (phpLDAPadmin) - Visual Interface for LDAP
  # ---------------------------------------------------------------------------
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: but_tc_ldap_admin
    restart: unless-stopped
    ports:
      - '8081:80'
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldap
      - PHPLDAPADMIN_HTTPS=false
    depends_on:
      - ldap
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # File Storage (Nextcloud) - Mocking IUT Nextcloud
  # ---------------------------------------------------------------------------
  nextcloud:
    image: nextcloud:stable-apache
    container_name: but_tc_nextcloud
    restart: unless-stopped
    ports:
      - "8082:80"
    extra_hosts:
      - "projet-edu.eu:host-gateway"
    environment:
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=Rangetachambre76*
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost 127.0.0.1 nextcloud projet-edu.eu
      # RESTORED: No overwrite config, letting it behave naturally on port 8082
      # Using SQLite for the dev instance
      - SQLITE_DATABASE=nextcloud
    volumes:
      - nextcloud_data:/var/www/html
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # OnlyOffice Document Server
  # ---------------------------------------------------------------------------
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: but_tc_onlyoffice
    restart: unless-stopped
    ports:
      - "8083:80"
    extra_hosts:
      - "projet-edu.eu:host-gateway"
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=onlyoffice_secret
      - JWT_HEADER=Authorization
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Mail Server (Mailpit) - Mocking SMTP
  # ---------------------------------------------------------------------------
  mailpit:
    image: axllent/mailpit
    container_name: but_tc_mail
    restart: unless-stopped
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP Port
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Mattermost (PostgreSQL)
  # ---------------------------------------------------------------------------
  db_mattermost:
    image: postgres:15-alpine
    container_name: but_tc_db_mattermost
    restart: unless-stopped
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmpassword
      POSTGRES_DB: mattermost
    volumes:
      - mattermost_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Mattermost Team Edition
  # ---------------------------------------------------------------------------
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: but_tc_mattermost
    restart: unless-stopped
    depends_on:
      - db_mattermost
    environment:
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:mmpassword@db_mattermost:5432/mattermost?sslmode=disable&connect_timeout=10
      - MM_SERVICESETTINGS_SITEURL=http://localhost:8065
      - MM_SERVICESETTINGS_ALLOWEDUNTRUSTEDINTERNALCONNECTIONS=localhost 127.0.0.1
      - MM_SERVICESETTINGS_ENABLEDEVELOPER=true
    ports:
      - "8065:8065"
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_config:/mattermost/config
      - mattermost_logs:/mattermost/logs
      - mattermost_plugins:/mattermost/plugins
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./apps/api
    container_name: but_tc_api
    restart: unless-stopped
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://app_user:app_password@db:5432/skills_db
      - LDAP_URL=ldap://ldap:389
      - LDAP_BASE_DN=dc=univ,dc=fr
      # Nextcloud URL is now DIRECT
      - NEXTCLOUD_URL=http://projet-edu.eu:8082
      - NEXTCLOUD_ADMIN=admin
      - NEXTCLOUD_PASS=Rangetachambre76*
      - ROOT_PATH=/api
    # API kept hidden behind Gateway
    networks:
      - app_network

  web:
    build:
      context: ./apps/web
    container_name: but_tc_web
    restart: unless-stopped
    depends_on:
      - api
    # Web kept hidden behind Gateway
    networks:
      - app_network

  dashboard:
    build:
      context: ./apps/dashboard
    container_name: but_tc_dashboard
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/local/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
      - api
    networks:
      - app_network

volumes:
  postgres_data:
  ldap_data:
  ldap_config:
  nextcloud_data:
  mattermost_db_data:
  mattermost_data:
  mattermost_config:
  mattermost_logs:
  mattermost_plugins:

networks:
  app_network:
    driver: bridge