services:
  # ---------------------------------------------------------------------------
  # Database (PostgreSQL)
  # ---------------------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: but_tc_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: skills_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backup_full_descriptions.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Authentication (LDAP officiel IUT)
  # Le serveur LDAP est externe, plus besoin du conteneur local 'ldap'
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # File Storage (Nextcloud) - Mocking IUT Nextcloud
  # ---------------------------------------------------------------------------
  nextcloud:
    image: nextcloud:stable-apache
    container_name: but_tc_nextcloud
    restart: unless-stopped
    ports:
      - "8082:80"
    extra_hosts:
      - "educ-ai.fr:host-gateway"
      - "nextcloud.educ-ai.fr:host-gateway"
      - "only-office.educ-ai.fr:host-gateway"
      - "home.educ-ai.fr:host-gateway"
    environment:
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=Rangetachambre76*
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost 127.0.0.1 nextcloud projet-edu.eu educ-ai.fr *.educ-ai.fr
      - OVERWRITEPROTOCOL=https
      # Using SQLite for the dev instance
      - SQLITE_DATABASE=nextcloud
    volumes:
      - nextcloud_data:/var/www/html
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # OnlyOffice Document Server
  # ---------------------------------------------------------------------------
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: but_tc_onlyoffice
    restart: unless-stopped
    ports:
      - "8083:80"
    extra_hosts:
      - "educ-ai.fr:host-gateway"
      - "nextcloud.educ-ai.fr:host-gateway"
      - "only-office.educ-ai.fr:host-gateway"
      - "home.educ-ai.fr:host-gateway"
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=onlyoffice_secret
      - JWT_HEADER=Authorization
      - USE_UNAUTHORIZED_STORAGE=true
      - ALLOW_PRIVATE_IP_ADDRESS=true
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Mattermost (PostgreSQL)
  # ---------------------------------------------------------------------------
  db_mattermost:
    image: postgres:15-alpine
    container_name: but_tc_db_mattermost
    restart: unless-stopped
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmpassword
      POSTGRES_DB: mattermost
    volumes:
      - mattermost_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Keycloak (PostgreSQL)
  # ---------------------------------------------------------------------------
  db_keycloak:
    image: postgres:15-alpine
    container_name: but_tc_db_keycloak
    restart: unless-stopped
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak_password
      POSTGRES_DB: keycloak
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Database for Odoo (PostgreSQL 15)
  # ---------------------------------------------------------------------------
  db_odoo:
    image: postgres:15-alpine
    container_name: but_tc_db_odoo
    restart: unless-stopped
    environment:
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: Rangetachambre76*
      POSTGRES_DB: postgres
    volumes:
      - odoo_db_data:/var/lib/postgresql/data
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Odoo ERP
  # ---------------------------------------------------------------------------
  odoo:
    image: odoo:17.0
    container_name: but_tc_odoo
    restart: unless-stopped
    depends_on:
      - db_odoo
    environment:
      - HOST=db_odoo
      - USER=odoo
      - PASSWORD=Rangetachambre76*
    # On utilise le fichier de configuration mont√©
    volumes:
      - ./apps/odoo/odoo.conf:/etc/odoo/odoo.conf
      - odoo_data:/var/lib/odoo
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Keycloak Identity Provider
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: but_tc_keycloak
    restart: unless-stopped
    command: start-dev --hostname-strict=false --import-realm
    environment:
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://db_keycloak:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloak_password
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=Rangetachambre76*
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_PROXY=edge
    volumes:
      - ./infrastructure/keycloak/import:/opt/keycloak/data/import
    depends_on:
      - db_keycloak
    ports:
      - "8080:8080"
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Mattermost Team Edition
  # ---------------------------------------------------------------------------
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: but_tc_mattermost
    restart: unless-stopped
    depends_on:
      - db_mattermost
    environment:
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:mmpassword@db_mattermost:5432/mattermost?sslmode=disable&connect_timeout=10
      - MM_SERVICESETTINGS_SITEURL=https://mattermost.educ-ai.fr
      - MM_SERVICESETTINGS_ALLOWEDUNTRUSTEDINTERNALCONNECTIONS=localhost 127.0.0.1 educ-ai.fr
      - MM_SERVICESETTINGS_ENABLEDEVELOPER=true
      - MM_LOGINSETTINGS_ENABLEOAUTHGAMES=false
      - MM_GITLABSETTINGS_ENABLE=true
      - MM_GITLABSETTINGS_ID=mattermost-app
      - MM_GITLABSETTINGS_SECRET=mattermost_secret_key_76
      - MM_GITLABSETTINGS_DISCOVERYENDPOINT=https://keycloak.educ-ai.fr/realms/but-tc/.well-known/openid-configuration
      - MM_GITLABSETTINGS_AUTHENDPOINT=https://keycloak.educ-ai.fr/realms/but-tc/protocol/openid-connect/auth
      - MM_GITLABSETTINGS_TOKENENDPOINT=https://keycloak.educ-ai.fr/realms/but-tc/protocol/openid-connect/token
      - MM_GITLABSETTINGS_USERAPIENDPOINT=https://keycloak.educ-ai.fr/realms/but-tc/protocol/openid-connect/userinfo
      - MM_GITLABSETTINGS_BUTTONTEXT=Connexion avec Keycloak
    ports:
      - "8065:8065"
    volumes:
      - mattermost_data:/mattermost/data
      - mattermost_config:/mattermost/config
      - mattermost_logs:/mattermost/logs
      - mattermost_plugins:/mattermost/plugins
    networks:
      - app_network

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./apps/api
    container_name: but_tc_api
    restart: unless-stopped
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://app_user:app_password@db:5432/skills_db
      - LDAP_URL=ldap://ldap.univ-lehavre.fr:389
      - LDAP_BASE_DN=dc=univ-lehavre,dc=fr
      - LDAP_BIND_DN=cn=ldapbindusr-caucri2,ou=DSA,dc=univ-lehavre,dc=fr
      - LDAP_BIND_PASSWORD=Fctldap-8%caucri2_30688
      - NEXTCLOUD_URL=https://nextcloud.educ-ai.fr
      - NEXTCLOUD_ADMIN=admin
      - NEXTCLOUD_PASS=Rangetachambre76*
      - NEXTCLOUD_SERVICE_USER=hub-service
      - NEXTCLOUD_SERVICE_PASS=Rangetachambre76*
      - ROOT_PATH=/api
      - KEYCLOAK_URL=http://but_tc_keycloak:8080
      - KEYCLOAK_REALM=but-tc
      - KEYCLOAK_CLIENT_ID=skills-hub-app
      - KEYCLOAK_CLIENT_SECRET=ASzD8MghmcXaTSas1MvjiK9o81DrlEeO
      # Odoo Database Direct Access (for admin tasks)
      - ODOO_DB_URL=postgresql://odoo:Rangetachambre76*@db_odoo:5432/postgres
      # Configuration Mail OVH
      - SMTP_HOST=ssl0.ovh.net
      - SMTP_PORT=465
      - SMTP_USER=votre-email@domaine.com
      - SMTP_PASS=votre-mot-de-passe
      - SMTP_TLS=true
    networks:
      - app_network

  web:
    build:
      context: ./apps/web
    container_name: but_tc_web
    restart: unless-stopped
    depends_on:
      - api
    # Web kept hidden behind Gateway
    networks:
      - app_network

  dashboard:
    build:
      context: ./apps/dashboard
    container_name: but_tc_dashboard
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/local/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
      - api
    networks:
      - app_network

volumes:
  postgres_data:
  ldap_data:
  ldap_config:
  nextcloud_data:
  mattermost_db_data:
  keycloak_db_data:
  mattermost_data:
  mattermost_config:
  mattermost_logs:
  mattermost_plugins:
  odoo_data:
  odoo_db_data:

networks:
  app_network:
    driver: bridge